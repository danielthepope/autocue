<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <a href="/edit-script/{{script_id}}">Edit this script</a>
    <span id="speed-indicator">Gamepad not detected</span>
    <div class="autocue">
        {%- for line in text -%}
        {{ line }}
        <br />
        {%- endfor -%}
    </div>

    <script>
        var speed = 0;
        var delay = 100;
        function pageScroll() {
            window.scrollBy(0, speed);
            scrolldelay = setTimeout(pageScroll, delay);
        }
        pageScroll();
        var speedIndicator = document.getElementById("speed-indicator");

        window.addEventListener("gamepadconnected", function (e) {
            var gp = navigator.getGamepads()[e.gamepad.index];
            speedIndicator.innerHTML = "Gamepad connected";

            gamepadLoop();
        });

        function gamepadLoop() {
            var gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads : []);
            var gp = gamepads[0];

            // debugger;
            var triggerPressure = Math.floor(gp.buttons[7].value * 100) || Math.floor(gp.buttons[6].value * -100);
            if (Math.abs(triggerPressure) < 5) {
                speed = 0;
                delay = 100;
            } else if (triggerPressure >= 5) {
                speed = 1;
                delay = 100 - triggerPressure;
            } else {
                speed = -1;
                delay = 100 + triggerPressure;
            }

            speedIndicator.innerHTML = `triggerPressure=${triggerPressure}; speed=${speed}; delay=${delay}`;

            requestAnimationFrame(gamepadLoop);
        }
    </script>
</body>

</html>